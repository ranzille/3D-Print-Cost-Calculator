<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Print Command Center</title>
    <style>
        :root {
            /* Palette */
            --brand-primary: #00AE42; /* Bambu Green */
            --brand-dark: #007a2e;
            --slate-900: #18181b; /* Dark Slate */
            --slate-800: #27272a;
            --slate-600: #52525b;
            --slate-400: #a1a1aa;
            --slate-100: #f4f4f5;
            --white: #ffffff;
            --border: #e4e4e7;
            --danger: #ef4444;
            
            /* Spacing & Radius */
            --radius-md: 8px;
            --radius-lg: 12px;
            --space-sm: 8px;
            --space-md: 16px;
            --space-lg: 24px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #f0f2f5;
            color: var(--slate-900);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        /* --- Layout Grid --- */
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--space-lg);
            display: grid;
            grid-template-columns: 1fr 400px; /* Split Pane */
            gap: 32px;
            align-items: start;
        }

        /* --- Headers --- */
        .app-header {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: var(--space-md);
            border-bottom: 1px solid var(--border);
            margin-bottom: var(--space-md);
        }

        .brand-title {
            font-size: 1.5rem;
            font-weight: 800;
            letter-spacing: -0.02em;
            color: var(--slate-900);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand-badge {
            background: var(--brand-primary);
            color: white;
            padding: 4px 10px;
            border-radius: 99px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* --- Sections & Zones --- */
        .zone-header {
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--slate-600);
            margin: 32px 0 16px 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .zone-header::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border);
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        /* --- Cards --- */
        .card {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .card h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: var(--space-md);
            color: var(--slate-900);
        }

        /* --- Inputs --- */
        .input-group {
            margin-bottom: var(--space-md);
        }

        .input-group:last-child {
            margin-bottom: 0;
        }

        label {
            display: block;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--slate-600);
            margin-bottom: 6px;
        }

        .input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .prefix, .suffix {
            position: absolute;
            color: var(--slate-400);
            font-size: 0.9rem;
            pointer-events: none;
        }
        
        .prefix { left: 12px; }
        .suffix { right: 12px; }

        input[type="number"], input[type="text"] {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 0.95rem;
            font-family: inherit;
            color: var(--slate-900);
            background: var(--slate-100);
            transition: all 0.2s;
        }
        
        input[type="number"].has-prefix { padding-left: 28px; }
        input[type="number"].has-suffix { padding-right: 40px; }

        input:focus {
            outline: none;
            background: var(--white);
            border-color: var(--brand-primary);
            box-shadow: 0 0 0 3px rgba(0, 174, 66, 0.15);
        }

        .hint {
            font-size: 0.75rem;
            color: var(--slate-400);
            margin-top: 4px;
        }

        /* --- Sticky Financial HUD --- */
        .sticky-hud {
            position: sticky;
            top: 24px;
            background: var(--slate-900);
            color: var(--white);
            border-radius: var(--radius-lg);
            padding: 0; /* Reset for inner structure */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .hud-header {
            padding: 24px 24px 0 24px;
        }

        /* Segmented Control */
        .segmented-control {
            display: flex;
            background: var(--slate-800);
            padding: 4px;
            border-radius: var(--radius-md);
            margin-top: 12px;
            position: relative;
        }

        .segmented-option {
            flex: 1;
            text-align: center;
            padding: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--slate-400);
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
            position: relative;
            z-index: 2;
        }

        .segmented-option.active {
            color: var(--white);
            background: var(--brand-primary);
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        
        /* Hidden Checkbox for Logic */
        #viewToggle { display: none; }

        .hud-body {
            padding: 24px;
            flex: 1;
        }

        .breakdown-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-size: 0.9rem;
            color: var(--slate-400);
        }

        .breakdown-row.highlight {
            color: var(--white);
            font-weight: 500;
            border-top: 1px solid var(--slate-800);
            padding-top: 12px;
            margin-top: 12px;
        }

        .breakdown-row.sub {
            padding-left: 12px;
            border-left: 2px solid var(--slate-800);
            font-size: 0.8rem;
        }
        
        .breakdown-row.fee { color: var(--danger); }

        .hud-footer {
            background: var(--slate-800);
            padding: 24px;
            border-top: 1px solid #3f3f46;
        }

        .stat-block {
            text-align: center;
            margin-bottom: 20px;
        }

        .stat-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--slate-400);
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--white);
            line-height: 1;
        }
        
        .stat-value.profit { color: var(--brand-primary); }

        .btn-action {
            width: 100%;
            background: var(--brand-primary);
            color: white;
            border: none;
            padding: 14px;
            border-radius: var(--radius-md);
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .btn-action:hover { background: var(--brand-dark); }
        .btn-reset { margin-top: 12px; background: transparent; color: var(--slate-400); font-size: 0.85rem; font-weight: 500; }
        .btn-reset:hover { color: var(--white); }

        /* --- Dynamic List --- */
        .extra-row {
            display: grid;
            grid-template-columns: 1fr 100px 32px;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .btn-remove {
            background: #fee2e2;
            color: var(--danger);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-add-extra {
            width: 100%;
            padding: 8px;
            border: 1px dashed var(--brand-primary);
            color: var(--brand-primary);
            background: #f0fdf4;
            border-radius: var(--radius-md);
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .dashboard-container {
                grid-template-columns: 1fr;
            }
            .sticky-hud {
                position: static;
                order: -1; /* Show results on top on mobile */
            }
        }
    </style>
</head>
<body>

    <div class="dashboard-container">
        
        <!-- HEADER -->
        <div class="app-header">
            <div class="brand-title">
                3D Print Command Center
                <span class="brand-badge">Pro</span>
            </div>
            <div style="font-size: 0.85rem; color: var(--slate-600);">
                <span id="saveStatus">● Auto-Saved</span>
            </div>
        </div>

        <!-- LEFT PANE: INPUTS -->
        <div class="inputs-pane">
            
            <!-- ZONE 1: JOB SPECIFICATIONS -->
            <div class="zone-header">01 // Production Specs</div>
            <div class="card-grid">
                
                <!-- Batch Card -->
                <div class="card" style="border-left: 4px solid var(--brand-primary);">
                    <h3>Batch Configuration</h3>
                    <div class="input-group">
                        <label>Quantity Printed</label>
                        <div class="input-wrapper">
                            <input type="number" id="batchQty" placeholder="1" value="1" class="has-suffix">
                            <span class="suffix">pcs</span>
                        </div>
                        <div class="hint">Total items in this print job</div>
                    </div>
                </div>

                <!-- Material Card -->
                <div class="card">
                    <h3>Material Data</h3>
                    <div class="input-group">
                        <label>Filament Cost (1kg)</label>
                        <div class="input-wrapper">
                            <span class="prefix">₱</span>
                            <input type="number" id="matCost" class="save-pref has-prefix" placeholder="850.00">
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Total Filament Used</label>
                        <div class="input-wrapper">
                            <input type="number" id="matGrams" class="has-suffix" placeholder="150">
                            <span class="suffix">g</span>
                        </div>
                    </div>
                </div>

                <!-- Time Card -->
                <div class="card">
                    <h3>Print Time (Total)</h3>
                    <div class="input-group" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <div>
                            <label>Hours</label>
                            <input type="number" id="timeHours" placeholder="2">
                        </div>
                        <div>
                            <label>Minutes</label>
                            <input type="number" id="timeMinutes" placeholder="30">
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Post-Processing / Extras</label>
                        <div id="extrasContainer"></div>
                        <button class="btn-add-extra" onclick="addExtraRow()">+ Add Part (Screw, Glue)</button>
                    </div>
                </div>

            </div>

            <!-- ZONE 2: FACTORY OVERHEAD -->
            <div class="zone-header">02 // Factory Overhead</div>
            <div class="card-grid">
                
                <!-- Machine Card -->
                <div class="card">
                    <h3>Machine Depreciation</h3>
                    <div class="input-group">
                        <label>Machine Cost</label>
                        <div class="input-wrapper">
                            <span class="prefix">₱</span>
                            <input type="number" id="machineCost" class="save-pref has-prefix" placeholder="20000">
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Est. Lifespan</label>
                        <div class="input-wrapper">
                            <input type="number" id="lifespanHours" class="save-pref has-suffix" placeholder="3000">
                            <span class="suffix">hrs</span>
                        </div>
                    </div>
                </div>

                <!-- Operations Card -->
                <div class="card">
                    <h3>Operations & Energy</h3>
                    <div class="input-group">
                        <label>Power Draw</label>
                        <div class="input-wrapper">
                            <input type="number" id="powerWatts" class="save-pref has-suffix" placeholder="150">
                            <span class="suffix">W</span>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Elec. Rate (kWh)</label>
                        <div class="input-wrapper">
                            <span class="prefix">₱</span>
                            <input type="number" id="elecRate" class="save-pref has-prefix" placeholder="12.00">
                        </div>
                    </div>
                </div>

                <!-- Labor Card -->
                <div class="card">
                    <h3>Labor & Risk</h3>
                    <div class="input-group">
                        <label>Labor Rate / Hr</label>
                        <div class="input-wrapper">
                            <span class="prefix">₱</span>
                            <input type="number" id="laborRate" class="save-pref has-prefix" placeholder="100.00">
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Prep/Post Time</label>
                        <div class="input-wrapper">
                            <input type="number" id="laborMins" class="save-pref has-suffix" placeholder="15">
                            <span class="suffix">min</span>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Failure Margin</label>
                        <div class="input-wrapper">
                            <input type="number" id="failMargin" class="save-pref has-suffix" placeholder="10">
                            <span class="suffix">%</span>
                        </div>
                    </div>
                </div>

            </div>

            <!-- ZONE 3: COMMERCIAL STRATEGY -->
            <div class="zone-header">03 // Commercial Strategy</div>
            <div class="card-grid">
                
                <!-- Fees Card -->
                <div class="card">
                    <h3>Fees & Tax</h3>
                    <div class="input-group">
                        <label>Platform Fee (Shopee/Lazada)</label>
                        <div class="input-wrapper">
                            <input type="number" id="platformFee" class="save-pref has-suffix" placeholder="7">
                            <span class="suffix">%</span>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Tax Rate</label>
                        <div class="input-wrapper">
                            <input type="number" id="taxRate" class="save-pref has-suffix" placeholder="0">
                            <span class="suffix">%</span>
                        </div>
                    </div>
                </div>

                <!-- Logistics Card -->
                <div class="card">
                    <h3>Logistics (Per Unit)</h3>
                    <div class="input-group">
                        <label>Packaging</label>
                        <div class="input-wrapper">
                            <span class="prefix">₱</span>
                            <input type="number" id="packagingCost" class="save-pref has-prefix" placeholder="15.00">
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Shipping</label>
                        <div class="input-wrapper">
                            <span class="prefix">₱</span>
                            <input type="number" id="shippingCost" class="save-pref has-prefix" placeholder="0.00">
                        </div>
                    </div>
                </div>

                <!-- Profit Card -->
                <div class="card" style="border-color: var(--brand-primary);">
                    <h3>Profit Goal</h3>
                    <div class="input-group">
                        <label>Markup Percentage</label>
                        <div class="input-wrapper">
                            <input type="number" id="markup" class="save-pref has-suffix" placeholder="50">
                            <span class="suffix">%</span>
                        </div>
                        <div class="hint">Applied after all costs</div>
                    </div>
                </div>

            </div>

        </div>

        <!-- RIGHT PANE: STICKY HUD -->
        <div class="sticky-hud">
            
            <div class="hud-header">
                <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--slate-400);">Display Mode</div>
                <div class="segmented-control">
                    <!-- Hidden Logic Checkbox -->
                    <input type="checkbox" id="viewToggle" onchange="toggleView()">
                    
                    <div class="segmented-option active" id="optUnit" onclick="setMode(true)">Per Unit</div>
                    <div class="segmented-option" id="optBatch" onclick="setMode(false)">Total Batch</div>
                </div>
            </div>

            <div class="hud-body">
                <div class="breakdown-row">
                    <span>Raw Material</span>
                    <span id="resMaterial">₱0.00</span>
                </div>
                <div class="breakdown-row">
                    <span>Extras & Parts</span>
                    <span id="resExtras">₱0.00</span>
                </div>
                <div class="breakdown-row">
                    <span>Energy & Machine</span>
                    <span id="resDepreciationPlusEnergy">₱0.00</span>
                </div>
                <div class="breakdown-row">
                    <span>Labor</span>
                    <span id="resLabor">₱0.00</span>
                </div>
                <div class="breakdown-row">
                    <span>Failure Buffer <small id="resFailPercent"></small></span>
                    <span id="resFailure">₱0.00</span>
                </div>

                <div class="breakdown-row highlight">
                    <span>Production Cost</span>
                    <span id="resProductionCost">₱0.00</span>
                </div>

                <!-- Commercial Addons -->
                <div class="breakdown-row sub">
                    <span>+ Packaging</span>
                    <span id="resPackaging">₱0.00</span>
                </div>
                <div class="breakdown-row sub">
                    <span>+ Tax (<span id="resTaxPercent">0</span>%)</span>
                    <span id="resTax">₱0.00</span>
                </div>
                 <div class="breakdown-row sub">
                    <span>+ Shipping</span>
                    <span id="resShipping">₱0.00</span>
                </div>
                <div class="breakdown-row sub fee">
                    <span>+ Platform Fee</span>
                    <span id="resPlatformFee">₱0.00</span>
                </div>

                <div class="breakdown-row highlight">
                    <span>Total Cost Basis</span>
                    <span id="resTotalCostBasis">₱0.00</span>
                </div>
            </div>

            <div class="hud-footer">
                <div class="stat-block">
                    <div class="stat-label">Final Price</div>
                    <div class="stat-value" id="resFinalPrice">₱0.00</div>
                    <div style="font-size:0.8rem; color:var(--slate-400); margin-top:4px;">
                        <span id="resMarkupPercent">0</span>% Markup
                    </div>
                </div>

                <div class="stat-block">
                    <div class="stat-label">Net Profit</div>
                    <div class="stat-value profit" id="resProfit">₱0.00</div>
                </div>

                <button class="btn-action" onclick="copyQuote()">Copy Quote</button>
                <button class="btn-action btn-reset" onclick="resetForm()">Reset Job Data</button>
                <div id="copyMsg" style="text-align:center; color: var(--brand-primary); font-size:0.8rem; margin-top:8px; opacity:0; transition:opacity 0.2s;">Copied!</div>
            </div>
        </div>

    </div>

    <!-- LOGIC SCRIPT (Preserved Logic + HUD Updates) -->
    <script>
        // DOM Elements
        const inputs = {
            batchQty: document.getElementById('batchQty'),
            matCost: document.getElementById('matCost'),
            matGrams: document.getElementById('matGrams'),
            machineCost: document.getElementById('machineCost'),
            lifespanHours: document.getElementById('lifespanHours'),
            timeHours: document.getElementById('timeHours'),
            timeMinutes: document.getElementById('timeMinutes'),
            powerWatts: document.getElementById('powerWatts'),
            elecRate: document.getElementById('elecRate'),
            laborRate: document.getElementById('laborRate'),
            laborMins: document.getElementById('laborMins'),
            failMargin: document.getElementById('failMargin'),
            markup: document.getElementById('markup'),
            platformFee: document.getElementById('platformFee'),
            taxRate: document.getElementById('taxRate'),
            packagingCost: document.getElementById('packagingCost'),
            shippingCost: document.getElementById('shippingCost'),
        };

        const display = {
            material: document.getElementById('resMaterial'),
            extras: document.getElementById('resExtras'),
            depreciationPlusEnergy: document.getElementById('resDepreciationPlusEnergy'), // Combined for HUD
            labor: document.getElementById('resLabor'),
            failure: document.getElementById('resFailure'),
            failPercent: document.getElementById('resFailPercent'),
            productionCost: document.getElementById('resProductionCost'),
            packaging: document.getElementById('resPackaging'),
            tax: document.getElementById('resTax'),
            taxPercent: document.getElementById('resTaxPercent'),
            totalCostBasis: document.getElementById('resTotalCostBasis'),
            finalPrice: document.getElementById('resFinalPrice'),
            markupPercent: document.getElementById('resMarkupPercent'),
            profit: document.getElementById('resProfit'),
            platformFee: document.getElementById('resPlatformFee'),
            shipping: document.getElementById('resShipping'),
            toggle: document.getElementById('viewToggle'),
            // UI Controls
            optUnit: document.getElementById('optUnit'),
            optBatch: document.getElementById('optBatch')
        };

        let calculatedData = { batch: {}, unit: {} };

        // --- View Controller ---
        function setMode(isUnit) {
            display.toggle.checked = isUnit;
            // Visual Update
            if (isUnit) {
                display.optUnit.classList.add('active');
                display.optBatch.classList.remove('active');
            } else {
                display.optUnit.classList.remove('active');
                display.optBatch.classList.add('active');
            }
            renderResults();
        }

        // --- Persistence Logic ---
        function loadSettings() {
            const saved = JSON.parse(localStorage.getItem('bambuCalcSettingsPH_CMD')) || {};
            document.querySelectorAll('.save-pref').forEach(input => {
                if (saved[input.id] !== undefined) input.value = saved[input.id];
            });
            if (!inputs.powerWatts.value) inputs.powerWatts.value = 150; 
            if (!inputs.failMargin.value) inputs.failMargin.value = 10;
            if (!inputs.platformFee.value) inputs.platformFee.value = 7;
        }

        function saveSettings() {
            const settings = {};
            document.querySelectorAll('.save-pref').forEach(input => {
                settings[input.id] = input.value;
            });
            localStorage.setItem('bambuCalcSettingsPH_CMD', JSON.stringify(settings));
        }

        // --- Dynamic Extras Logic ---
        function addExtraRow(name = '', cost = '') {
            const container = document.getElementById('extrasContainer');
            const div = document.createElement('div');
            div.className = 'extra-row';
            div.innerHTML = `
                <input type="text" placeholder="Item Name" class="extra-name" value="${name}">
                <input type="number" placeholder="₱" class="extra-cost" step="0.5" value="${cost}">
                <button class="btn-remove" onclick="removeExtraRow(this)">×</button>
            `;
            container.appendChild(div);
            div.querySelectorAll('input').forEach(i => i.addEventListener('input', calculate));
        }

        function removeExtraRow(btn) {
            btn.parentElement.remove();
            calculate();
        }

        function getExtrasTotal() {
            let total = 0;
            document.querySelectorAll('.extra-cost').forEach(input => {
                total += parseFloat(input.value) || 0;
            });
            return total;
        }

        // --- Calculation Core ---
        function calculate() {
            const v = {};
            for (let key in inputs) {
                v[key] = parseFloat(inputs[key].value) || 0;
            }

            const qty = Math.max(1, v.batchQty || 1);

            // 1. Batch Calculation
            const bMaterial = (v.matCost / 1000) * v.matGrams;
            const bExtras = getExtrasTotal();
            const totalHours = v.timeHours + (v.timeMinutes / 60);
            
            let bDepreciation = 0;
            if (v.lifespanHours > 0) {
                bDepreciation = (v.machineCost / v.lifespanHours) * totalHours;
            }

            const bEnergy = (v.powerWatts / 1000) * totalHours * v.elecRate;
            const bLabor = (v.laborRate / 60) * v.laborMins;

            const bSubtotal = bMaterial + bEnergy + bLabor + bDepreciation;
            const bFailure = bSubtotal * (v.failMargin / 100);
            const bProductionCost = bSubtotal + bFailure + bExtras;

            // 2. Unit Calculation
            const uProductionCost = bProductionCost / qty;
            const uPackaging = v.packagingCost;
            const uTaxAmt = (uProductionCost + uPackaging) * (v.taxRate / 100);
            const uTotalCostBasis = uProductionCost + uPackaging + uTaxAmt;
            const uProfit = uTotalCostBasis * (v.markup / 100);
            const uPriceBeforePlatform = uTotalCostBasis + uProfit;

            let uFinalPrice = 0;
            let uPlatformFee = 0;
            if (v.platformFee < 100) {
                uFinalPrice = uPriceBeforePlatform / (1 - (v.platformFee / 100));
                uPlatformFee = uFinalPrice - uPriceBeforePlatform;
            }
            const uShipping = v.shippingCost;

            // 3. Store Data
            calculatedData.unit = {
                material: bMaterial / qty,
                extras: bExtras / qty,
                energyDepreciation: (bEnergy + bDepreciation) / qty,
                labor: bLabor / qty,
                failure: bFailure / qty,
                productionCost: uProductionCost,
                packaging: uPackaging,
                tax: uTaxAmt,
                platformFee: uPlatformFee,
                shipping: uShipping,
                totalCostBasis: uTotalCostBasis,
                finalPrice: uFinalPrice,
                profit: uProfit
            };

            calculatedData.batch = {
                material: bMaterial,
                extras: bExtras,
                energyDepreciation: bEnergy + bDepreciation,
                labor: bLabor,
                failure: bFailure,
                productionCost: bProductionCost,
                packaging: uPackaging * qty,
                tax: uTaxAmt * qty,
                platformFee: uPlatformFee * qty,
                shipping: uShipping * qty,
                totalCostBasis: uTotalCostBasis * qty,
                finalPrice: uFinalPrice * qty,
                profit: uProfit * qty
            };

            renderResults();
            saveSettings();
        }

        function renderResults() {
            const isUnit = display.toggle.checked;
            const data = isUnit ? calculatedData.unit : calculatedData.batch;
            // Safe format handling to prevent "undefined" crashes
            const fmt = (num) => '₱' + (typeof num === 'number' ? num : 0).toLocaleString('en-PH', {minimumFractionDigits: 2, maximumFractionDigits: 2});

            display.material.innerText = fmt(data.material);
            display.extras.innerText = fmt(data.extras);
            display.depreciationPlusEnergy.innerText = fmt(data.energyDepreciation);
            display.labor.innerText = fmt(data.labor);
            display.failure.innerText = fmt(data.failure);
            display.failPercent.innerText = `(${inputs.failMargin.value}%)`;
            display.productionCost.innerText = fmt(data.productionCost);
            display.packaging.innerText = fmt(data.packaging);
            display.tax.innerText = fmt(data.tax);
            display.taxPercent.innerText = inputs.taxRate.value;
            display.shipping.innerText = fmt(data.shipping);
            display.platformFee.innerText = fmt(data.platformFee);
            display.totalCostBasis.innerText = fmt(data.totalCostBasis);
            display.finalPrice.innerText = fmt(data.finalPrice);
            display.markupPercent.innerText = inputs.markup.value;
            display.profit.innerText = fmt(data.profit);
        }

        function resetForm() {
            inputs.batchQty.value = '1';
            inputs.matGrams.value = '';
            inputs.timeHours.value = '';
            inputs.timeMinutes.value = '';
            document.getElementById('extrasContainer').innerHTML = '';
            calculate();
        }

        function copyQuote() {
            const isUnit = display.toggle.checked;
            const qty = inputs.batchQty.value;
            const price = document.getElementById('resFinalPrice').innerText;
            const mode = isUnit ? "Per Unit" : `Batch Total (${qty} pcs)`;
            
            const text = `3D Print Quote [${mode}]\n---\nMat: ${inputs.matGrams.value}g (Batch)\nTime: ${inputs.timeHours.value}h ${inputs.timeMinutes.value}m\nPrice: ${price}`;
            
            if (navigator.clipboard && window.isSecureContext) {
                 navigator.clipboard.writeText(text).then(showCopyMsg);
            } else {
                // Fallback
                try {
                    const ta = document.createElement('textarea');
                    ta.value = text;
                    document.body.appendChild(ta);
                    ta.select();
                    document.execCommand('copy');
                    document.body.removeChild(ta);
                    showCopyMsg();
                } catch(e) {}
            }
        }

        function showCopyMsg() {
            const msg = document.getElementById('copyMsg');
            msg.style.opacity = 1;
            setTimeout(() => msg.style.opacity = 0, 2000);
        }

        window.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            
            Object.values(inputs).forEach(input => {
                input.addEventListener('input', calculate);
            });
            
            inputs.batchQty.addEventListener('input', () => {
                calculate();
            });

            // Initialize Calculation Data BEFORE setting mode to prevent "undefined" error
            calculate();
            setMode(true); // Default to Unit View
        });
    </script>
</body>
</html>
